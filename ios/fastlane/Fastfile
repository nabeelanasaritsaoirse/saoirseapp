default_platform(:ios)

platform :ios do

  ############################################################
  # üì¶ Lane: match_certificates
  # Installs certificates & provisioning profiles
  ############################################################
  desc "Fetch App Store certificates & provisioning profiles"
  lane :match_certificates do
    match(
      type: "appstore",
      readonly: true,
      api_key_path: "./api_key.json",
      git_branch: "main",
      keychain_name: "build.keychain",
      keychain_password: "ci_keychain_pass"
    )
  end

  ############################################################
  # üèóÔ∏è Lane: build_app_store
  # Builds archive ONLY (no upload)
  ############################################################
  desc "Build iOS App Store archive"
  lane :build_app_store do
    gym(
      scheme: "Runner",
      workspace: "Runner.xcworkspace",
      configuration: "Release",
      export_method: "app-store",
      export_options: "ExportOptions.plist",
      clean: false,
      silent: false
    )
  end

  ############################################################
  # üöÄ Lane: upload_testflight
  # Uploads built .ipa to TestFlight using API key
  ############################################################
  desc "Upload IPA to TestFlight"
  lane :upload_testflight do
    api_key = app_store_connect_api_key(
      key_id: "HP977F376D",
      issuer_id: "03d18892-f203-42bd-acdf-60d56bc87724",
      key_filepath: "./api_key.json",
      duration: 1200,
      in_house: false
    )

    pilot(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end
end
