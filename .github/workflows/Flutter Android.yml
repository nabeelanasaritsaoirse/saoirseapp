name: ðŸ¤– Flutter Android Build and Deploy(Production)
run-name: "ðŸš€ Android Build by ${{ github.actor }} on ${{ github.ref_name }}"

permissions:
  contents: write
  checks: write
  pull-requests: write

on:
  push:
    tags:
      - "v*"

  # pull_request:
  #   branches: [ main, developer ]
  #   paths:
  #     - "android/**"
  #     - "lib/**"
  #     - "pubspec.yaml"
  #     - "pubspec.lock"

jobs:
  android-ci:
    runs-on: ubuntu-latest
    outputs:
      version_name: ${{ steps.version.outputs.VERSION_NAME }}
      version_code: ${{ steps.version.outputs.VERSION_CODE }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Flutter (3.35.7 Stable)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'

      - name: ðŸ“¦ Install Dependencies
        run: flutter pub get

      - name: ðŸ” Export Razorpay Secret
        run: |
          echo "RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}" >> $GITHUB_ENV

      - name: Generate .env file
        run: |
          cat > .env <<EOF
          RAZORPAY_KEY_ID=${{ secrets.RAZORPAY_KEY_ID }}
          CUSTOMER_SUPPORT_NUMBER=${{ secrets.CUSTOMER_SUPPORT_NUMBER }}
          IOS_API_KEY=${{ secrets.IOS_API_KEY }}
          IOS_APP_ID=${{ secrets.IOS_APP_ID }}
          IOS_MESSAGING_SENDER_ID=${{ secrets.IOS_MESSAGING_SENDER_ID }}
          IOS_PROJECT_ID=${{ secrets.IOS_PROJECT_ID }}
          
          ANDROID_API_KEY=${{ secrets.ANDROID_API_KEY }}
          ANDROID_APP_ID=${{ secrets.ANDROID_APP_ID }}
          ANDROID_MESSAGING_SENDER_ID=${{ secrets.ANDROID_MESSAGING_SENDER_ID }}
          ANDROID_PROJECT_ID=${{ secrets.ANDROID_PROJECT_ID }}
          EOF
      # ------------------------------
      # LINT (With success flag)
      # ------------------------------
      - name: ðŸ” Lint Check
        id: lint
        run: |
          flutter analyze
          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # ------------------------------
      # Install junitreport
      # ------------------------------
      - name: ðŸ“¦ Install junitreport
        run: dart pub global activate junitreport

      # ------------------------------
      # TEST (JSON + Convert to JUnit)
      # ------------------------------
      - name: ðŸ§ª Run Tests (JUnit Output)
        id: test
        run: |
          export PATH="$HOME/.pub-cache/bin:$PATH"
          flutter test --machine --no-pub > test_output.json || true
          dart pub global run junitreport:tojunit < test_output.json > test-results.xml || true
          if grep -q "<failure" test-results.xml; then
            echo "success=false" >> $GITHUB_OUTPUT
          else
            echo "success=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # ------------------------------
      # Publish Tests
      # ------------------------------
      - name: ðŸ“ˆ Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Flutter Test Results
          path: test-results.xml
          reporter: java-junit
          fail-on-error: false

      # ------------------------------
      # Summary
      # ------------------------------
      - name: ðŸ§¾ Add Lint + Test + Build Summary
        if: always()
        run: |
          echo "## ðŸ¤– Flutter Android CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Lint Issues" >> $GITHUB_STEP_SUMMARY
          # Run analyze without crashing CI
          flutter analyze --no-fatal-warnings --no-fatal-infos > lint.log || true
          # Show only meaningful issues
          if grep -E "error â€¢|warning â€¢|info â€¢" lint.log >/dev/null; then
            grep -E "error â€¢|warning â€¢|info â€¢" lint.log | head -n 20 >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No lint issues found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Test Summary" >> $GITHUB_STEP_SUMMARY
          if [ ! -f test-results.xml ]; then
            echo "âš ï¸ No test results found â€” tests may have crashed." >> $GITHUB_STEP_SUMMARY
            TOTAL=0
            FAILED=0
            PASSED=0
          else
            TOTAL=$(grep -o "<testcase" test-results.xml | wc -l)
            FAILED=$(grep -o "<failure" test-results.xml | wc -l)
            PASSED=$((TOTAL - FAILED))
          fi
          echo "- **Total Tests:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** ðŸŸ¢ $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** ðŸ”´ $FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$FAILED" -gt 0 ]; then
            echo "**Failed Tests (Top 10):**" >> $GITHUB_STEP_SUMMARY
            grep -oP '(?<=testcase name=").*?(?=")' test-results.xml | head -n 10 >> $GITHUB_STEP_SUMMARY
          fi
          
      # ------------------------------
      # FINAL GATE â€” BLOCK DEPLOY IF FAILED
      # ------------------------------
      # - name: âŒ Fail CI if Lint or Tests Failed
      #   if: always()
      #   run: |
      #     if [ "${{ steps.lint.outputs.success }}" != "true" ] || [ "${{ steps.test.outputs.success }}" != "true" ]; then
      #       echo "âŒ Lint or Tests Failed â€” stopping deploy"
      #       exit 1
      #     else
      #       echo "âœ… Lint & Tests Passed â€” deploy allowed"
      #     fi
          
      - name: ðŸ” Decode Android Keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 -d > android/app/android.keystore

      # Create key.properties
      - name: ðŸ”§ Configure Signing
        run: |
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=android.keystore
          EOF

          
      - name: ðŸ”¢ Read version from pubspec & generate versionCode
        id: version
        run: |
          VERSION_LINE=$(grep "^version:" pubspec.yaml)
          VERSION_NAME=$(echo "$VERSION_LINE" | cut -d '+' -f 1 | sed 's/version: //')
          VERSION_CODE=$GITHUB_RUN_NUMBER
      
          echo "Version Name: $VERSION_NAME"
          echo "Version Code: $VERSION_CODE"
          echo "Tag: ${{ github.ref_name }}"
      
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_OUTPUT


      - name: ðŸ—ï¸ Build Android APK & AAB
        run: |
          flutter build apk --release
          flutter build appbundle --release
      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: flutter-build
          path: |
            build/**/app-release.aab
            build/**/app-release.apk
            build/**/release/*.apk
            build/**/release/*.aab
  android-deploy:
    name: "ðŸš€ Android Deploy to Google Play"
    runs-on: ubuntu-latest
    needs: android-ci
    environment:
      name: playstore-deploy   # ðŸ‘ˆ Nishant must approve

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: flutter-build

      - name: ðŸ—ƒï¸ List downloaded files
        run: ls -R .

      - name: ðŸ“¦ Move AAB and APK to root for Fastlane
        run: |
          find . -name "*.aab" -exec mv {} app-release.aab \;
          find . -name "*.apk" -exec mv {} app-release.apk \;
  
      - name: ðŸ§¼ Remove APK (Google Play only accepts AAB)
        run: |
          if [ -f app-release.apk ]; then
            rm app-release.apk
          fi
      - name: ðŸ” Decode Android Keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 -d > android.keystore

      - name: ðŸ”§ Configure Signing
        run: |
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=../android.keystore
          EOF
      - name: ðŸ”§ Setup Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - run: gem install fastlane -N

      # - name: ðŸš€ Deploy to Google Play
      #   env:
      #     JSON_KEY: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
      #     PACKAGE_NAME: ${{ secrets.PACKAGE_NAME }}
      #   run: |
      #     echo "$JSON_KEY" > service_account.json
      #     fastlane supply \
      #       --aab app-release.aab \
      #       --json_key service_account.json \
      #       --package_name "$PACKAGE_NAME" \
      #       --track internal \
      #       --skip_upload_screenshots true \
      #       --skip_upload_images true

      - name: ðŸš€ Deploy to Google Play (Production)
        env:
          JSON_KEY: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          PACKAGE_NAME: ${{ secrets.PACKAGE_NAME }}
        run: |
          echo "$JSON_KEY" > service_account.json
          fastlane supply \
            --aab app-release.aab \
            --json_key service_account.json \
            --package_name "$PACKAGE_NAME" \
            --track production \
            --skip_upload_changelogs \
            --skip_upload_images \
            --skip_upload_screenshots
      - name: ðŸ§¾ Build Summary
        run: |
          echo "## ðŸš€ Google Play Deployment Summary" >> $GITHUB_STEP_SUMMARY
          
          if [ "${GITHUB_REF}" = "refs/heads/main" ]; then
            echo "Track: **Production**" >> $GITHUB_STEP_SUMMARY
          elif [ "${GITHUB_REF}" = "refs/heads/developer" ]; then
            echo "Track: **Internal Testing**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "Package: ${{ secrets.PACKAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
