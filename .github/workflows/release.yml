name: Automated Release Publishing
run-name: "ðŸš€ Release note"

on:
  push:
    tags:
      - 'android-v*'
      - 'ios-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        run: |
          TAG="${GITHUB_REF#refs/tags/}"

          # Detect platform
          if [[ "$TAG" == android-* ]]; then
            PLATFORM="Android"
            VERSION="${TAG#android-v}"
          else
            PLATFORM="iOS"
            VERSION="${TAG#ios-v}"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "PLATFORM=$PLATFORM" >> $GITHUB_ENV

      - name: Generate Auto Release Notes
        run: |
          set -e

          PREV_TAG=$(git tag --sort=-creatordate | grep -v "^${TAG}$" | head -n 1 || true)

          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..HEAD"
            COMPARE="${PREV_TAG} â†’ ${TAG}"
          else
            RANGE="HEAD"
            COMPARE="Initial release"
          fi

          echo "# ðŸš€ ${PLATFORM} Release v${VERSION}" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "## ðŸ“Œ Summary" >> RELEASE_NOTES.md
          echo "Automated release for ${PLATFORM} platform." >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "## ðŸ”§ Changes & Reasons" >> RELEASE_NOTES.md
          git log $RANGE --pretty=format:"- %s (%an)" >> RELEASE_NOTES.md || echo "- None" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "## ðŸž Bug Fixes" >> RELEASE_NOTES.md
          git log $RANGE --pretty=format:"%s" | grep -i fix | sed 's/^/- /' >> RELEASE_NOTES.md || echo "- None" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "## ðŸ›  Internal Improvements" >> RELEASE_NOTES.md
          git log $RANGE --pretty=format:"%s" | grep -Ei "ci|chore|refactor|build" | sed 's/^/- /' >> RELEASE_NOTES.md || echo "- None" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "## ðŸ” Commits" >> RELEASE_NOTES.md
          git log $RANGE --pretty=format:"- %s" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "## ðŸ“¦ Build" >> RELEASE_NOTES.md
          echo "Platform: ${PLATFORM}" >> RELEASE_NOTES.md
          echo "Version: ${VERSION}" >> RELEASE_NOTES.md
          echo "Compare: ${COMPARE}" >> RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: "${{ env.PLATFORM }} Release v${{ env.VERSION }}"
          body_path: RELEASE_NOTES.md
