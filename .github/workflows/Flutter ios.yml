name: ðŸŽ iOS CI & Deploy
run-name: "ðŸš€ iOS Build by ${{ github.actor }} on ${{ github.ref_name }}"

permissions:
  contents: read
  checks: write
  pull-requests: write

on:
  push:
    branches: [ main, developer ]
    paths:
      - "ios/**"
      - "assets/**"
      - "lib/**"
      - "pubspec.yaml"
      - "pubspec.lock"

  pull_request:
    branches: [ main, developer ]
    paths:
      - "ios/**"
      - "assets/**"
      - "lib/**"
      - "pubspec.yaml"
      - "pubspec.lock"

jobs:
  ios-ci:
    runs-on: macos-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Flutter (Stable)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'

      - name: ðŸ“¦ Install Dependencies
        run: flutter pub get

      # ------------------------------
      # LINT
      # ------------------------------
      - name: ðŸ” Lint Check
        id: lint
        run: |
          flutter analyze
          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      # Install junitreport
      - name: ðŸ“¦ Install junitreport
        run: dart pub global activate junitreport

      # ------------------------------
      # TEST
      # ------------------------------
      - name: ðŸ§ª Run Tests (JUnit Output)
        id: test
        run: |
          export PATH="$HOME/.pub-cache/bin:$PATH"
          flutter test --machine --no-pub > test_output.json || true
          dart pub global run junitreport:tojunit < test_output.json > test-results.xml || true
          if grep -q "<failure" test-results.xml; then
            echo "success=false" >> $GITHUB_OUTPUT
          else
            echo "success=true" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: ðŸ“ˆ Publish Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: iOS Test Results
          path: test-results.xml
          reporter: java-junit
          fail-on-error: false

      # ------------------------------
      # Summary
      # ------------------------------
      
      - name: ðŸ§¾ Add Lint + Test Summary
        if: always()
        run: |
          echo "## ðŸŽ iOS CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Lint Errors" >> $GITHUB_STEP_SUMMARY
      
          # Capture only error/warning/info related to Dart rules
          flutter analyze --no-fatal-warnings --no-fatal-infos > lint.log || true
      
          # Extract only analyzer messages (avoid_print, unnecessary_container, etc)
          grep -E "error â€¢|warning â€¢|info â€¢" lint.log >> $GITHUB_STEP_SUMMARY || \
            echo "No lint issues found ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
      
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Tests" >> $GITHUB_STEP_SUMMARY
          TOTAL=$(grep -o "<testcase" test-results.xml | wc -l)
          FAILED=$(grep -o "<failure" test-results.xml | wc -l)
          PASSED=$((TOTAL - FAILED))
      
          echo "- **Total Tests:** $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** ðŸŸ¢ $PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed:** ðŸ”´ $FAILED" >> $GITHUB_STEP_SUMMARY
      

      # ------------------------------
      # Fail if lint or tests failed
      # ------------------------------
      - name: âŒ Fail CI if Lint or Tests Failed
        if: always()
        run: |
          if [ "${{ steps.lint.outputs.success }}" != "true" ] || [ "${{ steps.test.outputs.success }}" != "true" ]; then
            echo "âŒ Lint or Tests Failed â€” stopping deploy"
            exit 1
          else
            echo "âœ… Lint & Tests Passed"
          fi

      # ------------------------------
      # Build iOS (NO CODESIGN)
      # ------------------------------
      - name: ðŸ Build iOS (No Codesign)
        run: flutter build ios --release --no-codesign

      # ------------------------------
      # Upload Runner.app (unsigned)
      # ------------------------------
      - name: ðŸ“¤ Upload iOS Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/Runner.app

  # -----------------------------------------
  # DEPLOY JOB (Requires Manual Approval)
  # -----------------------------------------
  ios-deploy:
    name: "ðŸš€ iOS Deploy to TestFlight"
    runs-on: macos-latest
    needs: ios-ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: ios-deploy

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download iOS Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-build
          path: ios-build/

      - name: ðŸŽ Setup Xcode
        run: sudo xcode-select -switch /Applications/Xcode.app

      - name: ðŸš€ Install Fastlane
        run: sudo gem install fastlane

      - name: ðŸ”§ Setup App Store Authentication
        run: |
          mkdir -p ~/.fastlane
          echo "{
            \"apple_id\": \"${{ secrets.APPLE_ID }}\",
            \"app_identifier\": \"${{ secrets.IOS_BUNDLE_ID }}\",
            \"itc_team_id\": \"${{ secrets.APP_STORE_TEAM_ID }}\"
          }" > ~/.fastlane/app_store_connect.json

      - name: ðŸ“¦ Package Runner.app into IPA
        run: |
          mkdir Payload
          cp -R ios-build/Runner.app Payload/
          zip -r app.ipa Payload

      - name: ðŸš€ Upload to TestFlight
        run: |
          fastlane pilot upload \
            --ipa app.ipa \
            --apple_id "${{ secrets.APPLE_ID }}" \
            --app_identifier "${{ secrets.IOS_BUNDLE_ID }}" \
            --itc_provider "${{ secrets.APP_STORE_TEAM_ID }}" \
            --skip_waiting_for_build_processing true
        env:
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.APP_SPECIFIC_PASSWORD }}
