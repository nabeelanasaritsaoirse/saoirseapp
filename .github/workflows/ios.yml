name: ðŸŽ iOS Release

on:
  push:
    branches: [ test ]
  workflow_dispatch:

env:
  BUNDLE_ID: com.saoirse.epi
  TEAM_ID: BYQUNNQSQH
  PROFILE_NAME: "match AppStore com.saoirse.epi 1765456537"

jobs:
  ios:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - run: flutter clean
      - run: flutter pub get

      # ðŸ”¥ Firebase config
      - name: Create GoogleService-Info.plist
        run: |
          cat > ios/Runner/GoogleService-Info.plist <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>API_KEY</key>
            <string>${{ secrets.IOS_API_KEY }}</string>
            <key>GCM_SENDER_ID</key>
            <string>${{ secrets.IOS_MESSAGING_SENDER_ID }}</string>
            <key>GOOGLE_APP_ID</key>
            <string>${{ secrets.IOS_APP_ID }}</string>
            <key>PROJECT_ID</key>
            <string>${{ secrets.IOS_PROJECT_ID }}</string>
            <key>BUNDLE_ID</key>
            <string>com.saoirse.epi</string>
          </dict>
          </plist>
          EOF

      # ðŸ§¹ Remove Main.storyboard (Flutter black screen bug)
      - run: |
          /usr/libexec/PlistBuddy -c "Delete :UIMainStoryboardFile" ios/Runner/Info.plist || true

      # ðŸ“± iPhone ONLY (no iPad = no iPad crash)
      - run: |
          /usr/libexec/PlistBuddy -c "Delete :UIDeviceFamily" ios/Runner/Info.plist || true
          /usr/libexec/PlistBuddy -c "Add :UIDeviceFamily array" ios/Runner/Info.plist
          /usr/libexec/PlistBuddy -c "Add :UIDeviceFamily:0 integer 1" ios/Runner/Info.plist

      # ðŸ“¦ Pods (force Firebase version sync)
  
      - run: |
          cd ios
          rm -rf Pods Podfile.lock
          pod install --repo-update
          pod update Firebase/Auth
          cd ..

      - name: â¬†ï¸ Force iOS 16 deployment target
        run: |
          sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [0-9.]\+;/IPHONEOS_DEPLOYMENT_TARGET = 16.0;/g' ios/Runner.xcodeproj/project.pbxproj

      - run: /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion 16.0" ios/Runner/Info.plist || true


      # ðŸ”¨ Flutter build
      - run: flutter build ios --release --no-codesign

      # ðŸ” Setup signing
      - run: |
          sudo gem install fastlane xcodeproj -N
          echo '${{ secrets.APP_STORE_CONNECT_API_KEY_JSON_BUILD }}' > ios/api_key.json
          
      - name: ðŸ” Fastlane Match
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        run: |
          cd ios
          fastlane match appstore \
            --readonly \
            --app_identifier "com.saoirse.epi" \
            --api_key_path ./api_key.json \
            --git_url https://github.com/nabeelanasaritsaoirse/ios-certificates.git \
            --git_branch main \
            --keychain_name build.keychain-db \
            --keychain_password "ci_keychain_pass"



      # ðŸ— Archive
      - run: |
          cd ios
          xcodebuild archive \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath build/Runner.xcarchive \
            -destination 'generic/platform=iOS' \
            DEVELOPMENT_TEAM=${{ env.TEAM_ID }} \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="${{ env.PROFILE_NAME }}" \
            CODE_SIGN_IDENTITY="Apple Distribution"

      # ðŸ“¦ Export IPA
      - run: |
          cd ios
          cat > ExportOptions.plist <<EOF
          <plist version="1.0"><dict>
            <key>method</key><string>app-store</string>
            <key>signingStyle</key><string>manual</string>
            <key>teamID</key><string>${{ env.TEAM_ID }}</string>
          </dict></plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ExportOptions.plist

      # ðŸš€ Upload
      - run: |
          fastlane deliver \
            --api_key_path ios/api_key.json \
            --ipa ios/build/ipa/*.ipa \
            --skip_metadata \
            --skip_screenshots \
            --force
