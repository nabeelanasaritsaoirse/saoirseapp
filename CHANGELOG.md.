#!/usr/bin/env bash
set -euo pipefail

PUBSPEC_FILE="pubspec.yaml"
CHANNEL="${CHANNEL:-prod}"   # dev | staging | prod

echo "ðŸ”– Versioning channel: $CHANNEL"

# ---------- Extract current version ----------
CURRENT_VERSION=$(grep -E '^version\s*:' "$PUBSPEC_FILE" | awk '{print $2}')

VERSION_NAME="${CURRENT_VERSION%%+*}"
BUILD_NUMBER="${CURRENT_VERSION##*+}"

BASE_VERSION="${VERSION_NAME%%-*}"
PRERELEASE_PART="${VERSION_NAME#*-}"
[[ "$PRERELEASE_PART" == "$VERSION_NAME" ]] && PRERELEASE_PART=""

IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

echo "ðŸ“¦ Current version : $VERSION_NAME+$BUILD_NUMBER"
echo "ðŸ“Œ Base version    : $MAJOR.$MINOR.$PATCH"
echo "ðŸ§ª Prerelease part : ${PRERELEASE_PART:-none}"

# ---------- Detect commit range ----------
LAST_TAG=$(git tag --sort=-creatordate | head -n 1 || true)

if [ -n "$LAST_TAG" ]; then
  RANGE="$LAST_TAG..HEAD"
else
  RANGE="HEAD"
fi

COMMITS=$(git log $RANGE --no-merges --pretty=format:"%s")

# ---------- Detect bump type ----------
BUMP="patch"

if echo "$COMMITS" | grep -qE 'BREAKING CHANGE|!:'; then
  BUMP="major"
elif echo "$COMMITS" | grep -q '^feat:'; then
  BUMP="minor"
fi

echo "ðŸš€ Detected version bump: $BUMP"

# ---------- Apply version bump ----------
case "$BUMP" in
  major)
    ((MAJOR++)); MINOR=0; PATCH=0 ;;
  minor)
    ((MINOR++)); PATCH=0 ;;
  patch)
    ((PATCH++)) ;;
esac

NEW_BASE="$MAJOR.$MINOR.$PATCH"

# ---------- Handle prerelease ----------
if [ "$CHANNEL" = "prod" ]; then
  NEW_VERSION_NAME="$NEW_BASE"
else
  LAST_PR_NUM=$(git tag --list "v$NEW_BASE-$CHANNEL.*" \
    | awk -F'.' '{print $NF}' \
    | sort -n \
    | tail -1 || true)

  PR_NUM=$(( ${LAST_PR_NUM:-0} + 1 ))
  NEW_VERSION_NAME="$NEW_BASE-$CHANNEL.$PR_NUM"
fi

# ---------- Bump build number ----------
((BUILD_NUMBER++))
NEW_VERSION="$NEW_VERSION_NAME+$BUILD_NUMBER"

echo "âœ… New version: $NEW_VERSION"

# ---------- Update pubspec.yaml ----------
sed -i "s/^version\s*:.*$/version: $NEW_VERSION/" "$PUBSPEC_FILE"

# ---------- Generate changelog ----------
{
  echo "## Version $NEW_VERSION"
  echo ""
  if [ -n "$COMMITS" ]; then
    echo "$COMMITS" | sed 's/^/- /'
  else
    echo "- Initial release"
  fi
} > CHANGELOG.md

echo "ðŸŽ‰ Version bump completed successfully"
